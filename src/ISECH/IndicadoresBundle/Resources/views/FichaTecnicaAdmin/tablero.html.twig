{# Modificado para que agregar el botón para ir al listado #}

{% extends 'IndicadoresBundle::standard_layout_tablero.html.twig' %}
{% block stylesheets %}
    {{ parent() }}
<link rel="stylesheet" href="{{ asset('bundles/indicadores/css/FichaTecnicaAdmin/tablero.css') }}" type="text/css" media="all" />
<link rel="stylesheet" href="{{ asset('bundles/indicadores/js/DataTables/media/css/jquery.dataTables.css') }}" type="text/css" media="all" />
<link rel="stylesheet" href="{{ asset('bundles/indicadores/js/DataTables/media/css/TableTools.css') }}" type="text/css" media="all" />

<!--EDITADO PARA NUEVOS TIPOS DE GRAFICOS (CSS)-->
<link rel="stylesheet" href="{{ asset('bundles/indicadores/css/FichaTecnicaAdmin/gauge.css') }}" type="text/css" media="all" />

<!--EDITADO PARA CHECBOXES TIPO SWITCH MATERIAL (CSS)-->
<link rel="stylesheet" href="{{ asset('bundles/indicadores/css/FichaTecnicaAdmin/material_switch.css') }}" type="text/css" media="all" />


{% endblock %}

{% block javascripts %}
    {{ parent() }}
    
<script type="text/javascript">
var rutahome = '{{ asset('bundles/indicadores/js/DataTables/media/swf/copy_csv_xls_pdf.swf') }}';
</script>    
<script src="{{ asset('bundles/indicadores/js/d3.min.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/d3pie.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/affix.min.js') }}" type="text/javascript"></script>

<script src="{{ asset('bundles/indicadores/js/FichaTecnicaAdmin/grafico_pastel.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/FichaTecnicaAdmin/grafico_columnas.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/FichaTecnicaAdmin/grafico_lineas.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/FichaTecnicaAdmin/tablero.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/FichaTecnicaAdmin/comun.js') }}" type="text/javascript"></script>
    
<!--EDITADO PARA NUEVOS TIPOS DE GRAFICOS-->
<script src="{{ asset('bundles/indicadores/js/SVG/rgbcolor.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/SVG/StackBlur.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/SVG/canvg.js') }}" type="text/javascript"></script>

<script src="{{ asset('bundles/indicadores/js/FichaTecnicaAdmin/grafico_gauge.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/FichaTecnicaAdmin/grafico_termometro.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/FichaTecnicaAdmin/iopctrl.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/FichaTecnicaAdmin/grafico_mapa.js') }}" type="text/javascript"></script>

<script src="{{ asset('bundles/indicadores/js/bridge_draggable_touch.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/jquery.ui.touch-punch.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/rasterizeHTML.allinone.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/DataTables/jquery.dataTables.min.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/DataTables/ZeroClipboard.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/DataTables/TableTools.min.js') }}" type="text/javascript"></script>

<!--EDITADO PARA EXPORTACION DE DATOS-->
<script src="{{ asset('bundles/indicadores/js/export_plugin/tableExport.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/export_plugin/filesaver.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/export_plugin/jquery.base64.js') }}" type="text/javascript"></script>
<!--EXPORTACION A PNG-->
<script src="{{ asset('bundles/indicadores/js/export_plugin/jspdf/jspdf.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/export_plugin/html2canvas.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/export_plugin/html2canvas.svg.js') }}" type="text/javascript"></script>
<!--EXPORTACION A PDF DICCIONARIO DE DATOS-->
<script src="{{ asset('bundles/indicadores/js/pdf/pdfmake.min.js') }}" type="text/javascript"></script>
<script src="{{ asset('bundles/indicadores/js/pdf/vfs_fonts.js') }}" type="text/javascript"></script>

<script>
$(document).ready(function(){
    $("#search_").autocomplete({
        source: "{{ path('autoComplete_Indicador') }}",
        select: function (a, b) 
        {
            var valor=b.item.value;
            valor=valor.split("]")[0];
            valor=valor.split("[")[1];  
            sala_agregar_fila();                                
            recuperarDimensiones(valor, null);
        },
        position: {
            my : "right top",
            at: "right bottom"
        }
    });
    $('#search_').click(function() {
        this.value="";
    });
    
});

</script>
<style>
.ui-autocomplete { max-height: 200px; overflow:visible; z-index:999999999}
</style>
{% endblock %}

{% block content %}

{% include 'IndicadoresBundle:FichaTecnicaAdmin:menu_tablero.html.twig' %}
<div class="container-fluid" id="contenedor_tablero">
    <div class="row" id="titulo_header" style="display:none;">
        <div class="col-md-12">
        <div class="page-header" style="padding:1px; margin-top:15px;  margin-bottom: -45px;"><h1 id="header_sala"></h1></div> 
        </div>
    </div>

    <div id="sala">
        
    </div>

</div>

<!-- Modal -->

<div id="myModal" class="modal fade" style="z-index:999999999">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="myModalLabel">{{'_sala_situacional_'|trans}}</h3>
        </div>
    
        <div class="modal-body">
            <label for="nombre_sala">{{'_nombre_sala_'|trans}}</label>
            <textarea id='nombre_sala' id-sala='' rows="3" style="width: 100%" class="form-control"></textarea>
            <span class='alert' id='info_sala'></span>
        </div>
    
        <div class="modal-footer">
            <button id='elimina_sala' class="btn btn-danger" style="display:none">
            <i class="glyphicon glyphicon-minus"></i> 
            {{'_eliminar_cambios_'|trans}}</button>
            
            <button id='guardar_sala' class="btn btn-primary">
            <i class="glyphicon glyphicon-ok"></i> 
            {{'_guardar_cambios_'|trans}}</button>
            
            <button class="btn btn-warning" data-dismiss="modal" aria-hidden="true">
            {{'_cerrar_'|trans}}</button>
        </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="myModal2" class="modal fade" style="z-index:999999999">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
       <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="myModalLabel2"></h4>
        </div>
        <div class="modal-body" style="max-height:400px; max-width:100%; overflow:auto;">
        <span class='info' id='sql'></span>
        </div>
        <div class="modal-footer">
        <button class="btn btn-warning" data-dismiss="modal" aria-hidden="true">{{'_cerrar_'|trans}}</button>
        </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->




<!-- Modal Menu-->  
<div id="myModalMenu" class="modal fade" style="z-index:99999999">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
            <h4 class="modal-tilte">{{"_Titulo_indicador"|trans}} </h4>
        </div>
        <div class="modal-body">
        
            <ul class="nav nav-tabs">
                <li class="active">
                <a href="#s53beb59d6d27d_1" data-toggle="tab">
                <i class="glyphicon glyphicon-exclamation-sign has-errors hide" data-original-title="" title=""></i>
                {{"_agregar_filtro_"|trans}} ({{clasificacionUso|length}})
                </a>
                </li>
                <li>
                <a href="#s53beb59d6d27d_2" data-toggle="tab">
                <i class="glyphicon glyphicon-exclamation-sign has-errors hide" data-original-title="" title=""></i>
                <i class="glyphicon glyphicon-star"></i> 
                {{"favoritos"|trans}} (<span id='cantidad_favoritos'>{{app.user.favoritos|length}}</span>)
                </a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="s53beb59d6d27d_1">
                    
                    <div class="col-lg-12"><br />
                        <div class="form-group">
                            <label for="s53beb59d6d27d_establecimiento">
                            {{'clasificacion_uso-eTAB'|trans}}
                            </label>
                            <select class="form-control" id="clasificacion_00">
                            <option value="xxx">
                                {{"_no_clasificados_"|trans}} (<span id='cantidad_no_clasificados'>{{indicadores_no_clasificados|length}})
                            </option>
                            {% for clasificacion in clasificacionUso %}
                                {% if clasificacion.codigo == app.user.clasificacionUso.codigo|default('') %}
                                <option value="{{clasificacion.id}}">
                                     {{clasificacion.descripcion}}
                                    {% for categoria in categorias%}
                                        {% if categoria.indicadores|length > 0 and categoria.cat.descripcion==clasificacion.descripcion   %}
                                            ({{categoria.indicadores|length}})
                                        {% endif %}
                                    {% endfor %}
                                </option>
                                {% else %}
                                <option value="{{clasificacion.id}}" >
                                    {{clasificacion.descripcion}}                                        
                                </option>
                                {% endif %}
                            {% endfor %}
                           </select>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label for="s53beb59d6d27d_establecimiento">
                            {{'clasificacion_tecnica'|trans}}
                            </label>
                            <select class="form-control" id="clasificacion_11">
                            
                           </select>
                        </div>
                    </div>
                
                    <div class="col-lg-12">
                        <div class="input-group">
                          <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                          <input type="text" id="search_1" class="form-control" placeholder="Buscar..." autocomplete="off">
                        </div>
                        <br />
                    </div>
                    
                    <div class="col-lg-12">
                        <ul id="miclasificacion" class="list-group" >
                            {% for indicador in indicadores_no_clasificados %}
                            
                                <li class='list-group-item'
                                     style="height:100%; min-height:55px; width:100%; display:block;">
                                    <button type="button" class="indicador pull-left btn" style="margin-right:15px" data-id='{{indicador.id}}'
                                    data-unidad-medida='{{indicador.unidadMedida}}' id='{{indicador.id}}'>
                                    <i class="glyphicon glyphicon-plus"></i>
                                    </button>
                                    {{indicador.nombre}}  <div class="clearfix"></div>                                  
                                </li>
                            
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="tab-pane" id="s53beb59d6d27d_2">
                    <div class="col-lg-12"><br />
                        <div class="input-group">
                          <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                          <input type="text" id="search_2" class="form-control"  placeholder="Buscar...">
                        </div> 
                        <br />                       
                    </div>
                    <div class="col-lg-12">
                        <ul class="list-group" id='listado-favoritos' >
                            {% for indicador in app.user.favoritos %}
                                
                                <li class='list-group-item'
                                     style="height:100%; min-height:55px; width:100%; display:block;">
                                    <button type="button" class="indicador pull-left btn" style="margin-right:15px" data-id='{{indicador.id}}'
                                    data-unidad-medida='{{indicador.unidadMedida}}' id='fav-{{indicador.id}}'>
                                    <i class="glyphicon glyphicon-plus"></i>
                                    </button>
                                    {{indicador.nombre}}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        <!-- fin body -->        
        </div>
        <div class="modal-footer" style="margin-top:-20px">
            <button class="btn btn-warning" data-dismiss="modal" aria-hidden="true">{{'_cerrar_'|trans}}</button>
        </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="exportarDatos" class="modal fade" style="z-index:999999999">
  <div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="myModalLabel">{{'_exportar_datos_lbl'|trans}}</h3>
        </div>
    
        <div class="modal-body row">
            <div class="col-lg-12">
                    <label>{{'_exportar_datos_opciones_'|trans}}</label>
            </div>
            <div class="col-lg-12">
                <ul class="list-group" id='listado-favoritos' >                             
                    <li class='list-group-item'>
                        <div class="material-switch">
                            <input id="exportar_csv" value="csv" name="exportar_opciones_radio" type="radio" checked/>
                            <label for="exportar_csv" class="label-primary">CSV</label>
                        </div>
                    </li>
                    <li class='list-group-item'>
                        <div class="material-switch">
                            <input id="exportar_xls" value="xls" name="exportar_opciones_radio" type="radio"/>
                            <label for="exportar_xls" class="label-primary">XLS</label>
                        </div>
                    </li>
                    <li class='list-group-item'>
                        <div class="material-switch">
                            <input id="exportar_xml" value="xml" name="exportar_opciones_radio" type="radio"/>
                            <label for="exportar_xml" class="label-primary">XML</label>
                        </div>
                    </li>
                    <!--li class='list-group-item'>
                        <div class="material-switch">
                            <input id="exportar_pdf" value="pdf" name="exportar_opciones_radio" type="radio"/>
                            <label for="exportar_pdf" class="label-primary">PDF</label>
                        </div>
                    </li-->
                </ul>
            </div>
        </div>
    
        <div class="modal-footer">
            
            <button id='exportar_datos_boton' class="btn btn-primary">
            <i class="glyphicon glyphicon-export"></i> 
            {{'_exportar_datos_boton_'|trans}}</button>
            
            <button class="btn btn-warning" data-dismiss="modal" aria-hidden="true">
            {{'_cerrar_'|trans}}</button>
        </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div id="exportarDiccionarioDatos" class="modal fade" style="z-index:999999999">
  <div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="myModalLabel">{{'_exportar_diccionario_datos_lbl'|trans}}</h3>
        </div>
        <div class="modal-body row">
            
                <div class="col-lg-12">
                <ul class="list-group" >
                    <li class='list-group-item'>
                        <div class="material-switch">
                            <input id="exportar_datos_xls" value="xls" name="exportar_datos_opciones_radio" type="radio"/>
                            <label for="exportar_datos_xls" class="label-primary">XLS</label>
                        </div>
                    </li>
                    <li class='list-group-item'>
                        <div class="material-switch">
                            <input id="exportar_datos_pdf" value="pdf" name="exportar_datos_opciones_radio" type="radio" checked/>
                            <label for="exportar_datos_pdf" class="label-primary">PDF</label>
                        </div>
                    </li>
                </ul>
            </div>
            
            <div id="contenedor_indicadores_diccionario">
                
            </div>
        </div>
    
        <div class="modal-footer">
            <button id='exportar_diccionario_boton' class="btn btn-primary">
            <i class="glyphicon glyphicon-export"></i> 
            {{'_exportar_datos_boton_'|trans}}</button>
            
            <button class="btn btn-warning" data-dismiss="modal" aria-hidden="true">
            {{'_cerrar_'|trans}}</button>
        </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


{% include 'IndicadoresBundle:FichaTecnicaAdmin:compartir_sala.html.twig' %}
{% include 'IndicadoresBundle:FichaTecnicaAdmin:accion_sala.html.twig' %}

<!-- Modal Salas-->  
<div id="myModalSalas" class="modal fade" style="z-index:99999999">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button><h4 class="modal-tilte">{{'_salas_'|trans}} </h4></div>
        <div class="modal-body">
            <div class="tab-content">
                <ul class="nav nav-tabs" id="salax">
                    <li class="active">
                    <a href="#salas_2" data-toggle="tab">
                    <i class="glyphicon glyphicon-exclamation-sign has-errors hide" data-original-title="" title=""></i>
                    Mis {{'_salas_'|trans}} ({{salasXusuario|length}})
                    </a>
                    </li>
                    <li>
                    <a href="#salas_3" data-toggle="tab">
                    <i class="glyphicon glyphicon-exclamation-sign has-errors hide" data-original-title="" title=""></i>
                    {{'_salas_'|trans}} X Grupo ({{salasXgrupo|length}})
                    </a>
                    </li>
                    <li>
                    <a href="#salas_1" data-toggle="tab">
                    <i class="glyphicon glyphicon-exclamation-sign has-errors hide" data-original-title="" title=""></i>
                    {{'_salas_'|trans}} ({{salas|length}})
                    </a>
                    </li>
                </ul>
            
                <div class="tab-content">
                    <div class="tab-pane  active" id="salas_1">
                        <div class="col-lg-12"><br />
                            <div class="input-group">
                              <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                              <input type="text" id="search_3" class="form-control"  placeholder="Buscar...">
                            </div> 
                            <br />                       
                        </div>
                        <div class="col-lg-12">
                            <ul class="list-group" id="misalax">                                    
                                {% for sala in salas %}
                                    <li  class="list-group-item" style="min-height:55px" id="n_{{sala.datos_sala.id}}">
                                        <button type="button" class="salas-id pull-left btn" style="margin-right:15px" data="{{sala.indicadores_sala|json_encode()}}" id='a_{{sala.datos_sala.id}}' sala-nombre='{{sala.datos_sala.nombre}}' sala-id='{{sala.datos_sala.id}}'>
                                        <i class="glyphicon glyphicon-plus"></i>
                                        </button>
                                        {{sala.datos_sala.nombre}}
                                                                                
                                    </li>
                                {% endfor %}
                            </ul>                                   
                      </div>
                  </div>
                  <div class="tab-pane" id="salas_2">
                       <div class="col-lg-12"><br />
                            <div class="input-group">
                              <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                              <input type="text" id="search_4" class="form-control"  placeholder="Buscar...">
                            </div> 
                            <span class='col-lg-12 alert' style="display:none" id='info_sala2'></span>
                            <br />                       
                      </div>
                      <div class="col-lg-12">
                        <ul class="list-group" id='misalax2' >
                            {% for sala in salasXusuario %}
                                <li  class="list-group-item" style="min-height:55px" id="u_{{sala.datos_sala.id}}">
                                    <button type="button" class="salas-id pull-left btn" style="margin-right:15px" data="{{sala.indicadores_sala|json_encode()}}" id='b_{{sala.datos_sala.id}}' sala-nombre='{{sala.datos_sala.nombre}}' sala-id='{{sala.datos_sala.id}}'>
                                        <i class="glyphicon glyphicon-plus"></i>
                                    </button>
                                    {{sala.datos_sala.nombre}}
                                    
                                    <a href="#myModal" onclick="openModalSala('{{sala.datos_sala.id}}','{{sala.datos_sala.nombre}}','0')" data-toggle="modal" class="btn btn-danger pull-right">
                                        <i class="fa fa-minus"></i> 
                                    </a>
                                    <a href="#myModal" onclick="openModalSala('{{sala.datos_sala.id}}','{{sala.datos_sala.nombre}}','1')"data-toggle="modal" class="btn btn-info pull-right" >
                                        <i class="fa fa-edit"></i> 
                                    </a>
                                    
                                </li>
                            {% endfor %}
                        </ul>
                     </div>                 
                  </div>
                  
                  
                  <div class="tab-pane" id="salas_3">
                     <div class="col-lg-12"><br />
                        <div class="input-group">
                          <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                          <input type="text" id="search_5" class="form-control"  placeholder="Buscar...">
                        </div> 
                        <br />                       
                     </div>
                     <div class="col-lg-12">
                        <ul class="list-group" id='misalax3' >                          
                            {% for sala in salasXgrupo %}
                                <li class="list-group-item" style="min-height:55px" id="g_{{sala.datos_sala.id}}">
                                    <button type="button" class="salas-id pull-left btn" style="margin-right:15px" data="{{sala.indicadores_sala|json_encode()}}" id='c_{{sala.datos_sala.id}}' sala-nombre='{{sala.datos_sala.nombre}}' sala-id='{{sala.datos_sala.id}}'>
                                        <i class="glyphicon glyphicon-plus"></i>
                                    </button>
                                    {{sala.datos_sala.nombre}}
                                </li>
                            {% endfor %}
                        </ul>
                     </div>
                  </div>
              </div>
           </div>
        </div>
        <div class="modal-footer" style="margin-top:-20px">
            <button class="btn btn-warning" data-dismiss="modal" aria-hidden="true">{{'_cerrar_'|trans}}</button>
        </div>
        
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<form id="htmlconstruido" style="display:none" target="_blank" method="post">
    <input type="text" id="htmlhtml" name="html">
    <input type="text" id="htmlheader" name="header">
    <input type="text" id="htmlfooter" name="footer">
    <input type="text" id="htmlnombre" name="nombre">
</form>
<div id="paraimprimir" style="display:none"></div>
<style>

#myModalMenu li, #myModalSalas li
{
    cursor:pointer;
}
#myModalMenu li:hover, #myModalSalas li:hover
{
    cursor:pointer;
    background-color:#EBEBEB;   
}
#myModalMenu a , #myModalSalas a
{
    text-decoration:none;
}
</style>
<script>
$(document).ready(function(){
    
        $('#exportar_datos_boton').click(function(){
            
            var datos = [];
            var opcion = $('input[name=exportar_opciones_radio]:checked').val();
            
            var elementos = [];
            var maxcollength = 0;
            
            $('#contenedor_tablero').find('.area_grafico').each(function(i,elemento){
                var zona = $(elemento).attr('id');
                var datasetPrincipal = JSON.parse($('#' + zona).attr('datasetPrincipal'));
                var nombre = $('#' + zona + ' .titulo_indicador').attr('nombre');
                var item = new Object();
                item.nombre = nombre;
                item.datos = datasetPrincipal;
                item.zona = zona;
                elementos[elementos.length] = item;
                var tamanio = objSize(datasetPrincipal[0]);
                maxcollength = (maxcollength < tamanio) ? tamanio : maxcollength;
            });
            
            if (opcion !== 'xls'){ 
                var tabla = '<table><tbody>';
                for (i = 0; i < elementos.length; i++) {
                    tabla += construir_tabla(elementos[i], maxcollength);
                }
                tabla += '</tbody></table>'; 
            }else{
                var tabla = [];
                var nombres = [];
                for (i = 0; i < elementos.length; i++) {
                    var tabla_item = '<table><tbody>';
                    tabla_item += construir_tabla(elementos[i], maxcollength);
                    tabla_item += '</tbody></table>';
                    
                    tabla[tabla.length] = tabla_item;
                    nombres[nombres.length] = 'Indicador '+(i+1);
                }
                
            }          
                                    
            switch(opcion){
                case 'xls':
                    
                    tablesToExcel(tabla, nombres, 'reporte.xls', 'Excel');
                    
                    //var excelData = $(tabla).tableExport({type:'excel',escape:'false'});
                    //var blob = new Blob([excelData], {type: "text/comma-separated-values;charset=utf-8"});
                    //saveAs(blob, "reporte.xls")
                    break;
                case 'csv':
                    var tdData = $(tabla).tableExport({type:'csv',escape:'false',separator: ','});                    
                    var blob = new Blob([tdData], {type: "text/comma-separated-values;charset=utf-8"});
                    saveAs(blob, "reporte.csv");
                    break;
                case 'xml':
                    var xmldata = $(tabla).tableExport({type:'xml',escape:'false'});
                    var blob = new Blob([xmldata], {type: "application/xml;charset=utf-8"});
                    saveAs(blob, "reporte.xml");
                    break;
               // case 'pdf':
               //     $(tabla).tableExport({type:'pdf',escape:'false',pdfLeftMargin : 10, pdfFontSize:10 });
               //     break;
            }
                        
        });
        
        $('#exportarDiccionarioDatos').on('shown.bs.modal', function (e) {
            
            $('#contenedor_indicadores_diccionario').html('');
            $('#contenedor_tablero').find('.area_grafico').each(function(i,elemento){
                
                var zona = $(elemento).attr('id');
                var nombre = $('#' + zona + ' .titulo_indicador').attr('nombre');
                var id = $('#' + zona + ' .titulo_indicador').attr('data-id');
                
                $('#contenedor_indicadores_diccionario').append('<div class="col-lg-12"><ul class="list-group"><li class="list-group-item"><div class="material-switch"><input class="grafico_exportar" nombre="'+nombre+'" data-id="'+id+'" id="indicador_'+zona+'" type="checkbox" checked/><label for="indicador_'+zona+'" class="label-primary" style="width:100%;">'+nombre+'</label></div></li></ul></div>');
            
            });
        
        });
        
        var tablesToExcel = (function() {
            var uri = 'data:application/vnd.ms-excel;base64,'
            , tmplWorkbookXML = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">'
              + '<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office"><Author>Axel Richter</Author><Created>{created}</Created></DocumentProperties>'
              + '<Styles>'
              + '<Style ss:ID="Currency"><NumberFormat ss:Format="Currency"></NumberFormat></Style>'
              + '<Style ss:ID="Date"><NumberFormat ss:Format="Medium Date"></NumberFormat></Style>'
              + '</Styles>' 
              + '{worksheets}</Workbook>'
            , tmplWorksheetXML = '<Worksheet ss:Name="{nameWS}"><Table>{rows}</Table></Worksheet>'
            , tmplCellXML = '<Cell{attributeStyleID}{attributeFormula}><Data ss:Type="{nameType}">{data}</Data></Cell>'
            , base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) }
            return function(tables, wsnames, wbname, appname) {
              var ctx = "";
              var workbookXML = "";
              var worksheetsXML = "";
              var rowsXML = "";
              for (var i = 0; i < tables.length; i++) {
                if (!tables[i].nodeType) {
                    tables[i] = $(tables[i])[0];
                }
                for (var j = 0; j < tables[i].rows.length; j++) {
                  rowsXML += '<Row>'
                  for (var k = 0; k < tables[i].rows[j].cells.length; k++) {
                    var dataType = tables[i].rows[j].cells[k].getAttribute("data-type");
                    var dataStyle = tables[i].rows[j].cells[k].getAttribute("data-style");
                    var dataValue = tables[i].rows[j].cells[k].getAttribute("data-value");
                    dataValue = (dataValue)?dataValue:$(tables[i].rows[j].cells[k]).text();
                    if($.isNumeric(dataValue)){
                        dataType = 'Number';
                    }
                    var dataFormula = tables[i].rows[j].cells[k].getAttribute("data-formula");
                    dataFormula = (dataFormula)?dataFormula:(appname=='Calc' && dataType=='DateTime')?dataValue:null;
                    ctx = {  attributeStyleID: (dataStyle=='Currency' || dataStyle=='Date')?' ss:StyleID="'+dataStyle+'"':''
                           , nameType: (dataType=='Number' || dataType=='DateTime' || dataType=='Boolean' || dataType=='Error')?dataType:'String'
                           , data: (dataFormula)?'':dataValue
                           , attributeFormula: (dataFormula)?' ss:Formula="'+dataFormula+'"':''
                          };
                    rowsXML += format(tmplCellXML, ctx);
                  }
                  rowsXML += '</Row>'
                }
                ctx = {rows: rowsXML, nameWS: wsnames[i] || 'Sheet' + i};
                worksheetsXML += format(tmplWorksheetXML, ctx);
                rowsXML = "";
              }
              ctx = {created: (new Date()).getTime(), worksheets: worksheetsXML};
              workbookXML = format(tmplWorkbookXML, ctx);
                //console.log(workbookXML);
              var link = document.createElement("A");
              link.href = uri + base64(workbookXML);
              link.download = wbname || 'Workbook.xls';
              link.target = '_blank';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }
          })();
        
        $('#exportar_diccionario_boton').click(function(){
                    
            var elementos = [];
            
            var opcion = $('input[name=exportar_datos_opciones_radio]:checked').val();
            
            $('#contenedor_indicadores_diccionario').find('.grafico_exportar').each(function(i,elemento){
                
                if(elemento.checked){
                    var zona = $(elemento).attr('id');
                    var nombre = $('#' + zona).attr('nombre');
                    var id = $('#' + zona).attr('data-id');
                    var item = new Object();
                    item.nombre = nombre;
                    item.id = id;
                    item.zona = zona;
                    
                    elementos[elementos.length] = item;   
                }            
        });
        if (opcion == 'pdf'){
            var dd = {
                content: [
                    { text: 'Diccionario de datos', style: 'subheader' }
                ],
                styles: {
                        header: {
                                fontSize: 18,
                                bold: true,
                                margin: [0, 0, 0, 10]
                        },
                        subheader: {
                                fontSize: 16,
                                bold: true,
                                margin: [0, 10, 0, 5]
                        },
                        tableExample: {
                                margin: [0, 5, 0, 15]
                        },
                        tableHeader: {
                                bold: true,
                                fontSize: 13,
                                color: 'black'
                        }
                }
            }
            var revisarfin = setInterval(function(){
                for(var i=0;i<elementos.length;i++){
                    if (elementos[i].datos == null){
                        return false;
                    }
                }
                    pdfMake.createPdf(dd).download('diccionario_indicadores.pdf');
                    cerrarintervalo();        
                }, 500);
                function cerrarintervalo(){
                    clearInterval(revisarfin); 
                }
            $(elementos).each(function(i,elemento){
                zona=$(this).attr("data-id");
                $.get(Routing.generate('get_indicador_ficha',{id: elemento.id}),
                    function(resp) {
                        var contenido = $(resp);
                        var tabla = $('table', contenido);
                        elemento.datos = tabla;
                        dd.content.push(construir_arreglo(elemento));
                }); 
            });
        
        } else if (opcion == 'xls'){
            var tablas = [];
            var nombres = [];
            
            var revisarfin = setInterval(function(){
            for(var i=0;i<elementos.length;i++){
                if (elementos[i].datos == null){
                    return false;
                }
            }
                //pdfMake.createPdf(dd).download('diccionario_indicadores.pdf');
                tablesToExcel(tablas, nombres, 'reporte.xls', 'Excel');
                cerrarintervalo();        
            }, 500);
            function cerrarintervalo(){
                clearInterval(revisarfin); 
            }
            
            $(elementos).each(function(i,elemento){
                zona=$(this).attr("data-id");
                $.get(Routing.generate('get_indicador_ficha',{id: elemento.id}),
                    function(resp) {
                        var contenido = $(resp);
                        var tabla = $('table', contenido);
                        elemento.datos = tabla;
                        tablas[tablas.length] = tabla;
                        nombres[nombres.length] = 'indicador '+(i+1);
                }); 
            });
        }             
        });
        
        function construir_arreglo(elemento) {
            var datos = elemento.datos;
            var nombre = elemento.nombre;
            
            var objeto = [];
            
            var titulo = new Object();
            titulo.text = nombre;
            titulo.style = 'subheader';
            objeto.push(titulo);
            
            var contenido = new Object();
            contenido.style = 'tableExample';
            contenido.table = new Object();
            contenido.table.headerRows = 1;
            contenido.table.body = [];
            var tabla = $(datos);
            tabla.find('tr').each(function(i,e) {
                
                var $tds = $(this).find('td');
                var $ths = $(this).find('th');
                var clave = $ths.eq(0).text();
                var valor = $tds.eq(0).text();
                
                var dato = new Object();
                
                if (i === 0) {
                    
                    headers = [];
                    var header1 = new Object();
                    header1.text = 'Campo';
                    header1.style = 'tableHeader';
                    headers.push(header1);
                    var header1 = new Object();
                    header1.text = 'Descripción';
                    header1.style = 'tableHeader';
                    headers.push(header1);
                        
                    contenido.table.body.push(headers);
                    
                }else{
                    var fila = [clave,valor];
                    contenido.table.body.push(fila);
                }
            });
         
            objeto.push(contenido);
            
            return objeto;
        }   
        function construir_tabla(elemento, tamanio) {
            var zona = elemento.zona;
            var datos = elemento.datos;
            var nombre = elemento.nombre;
            
            var tabla_datos = '<tr tipo="indicador"><td tipo="nombre" colspan="'+tamanio+'">'+nombre+'</td></tr>';
            
            $.each(datos, function(i, fila) {
                if (i === 0) {
                    tabla_datos += '<tr tipo="encabezado">';
                    var longitudfila = objSize(fila);
                    var count = 0;
                    for (var campo in fila) {
                        
                        count +=1;
                        var colspan = (count === longitudfila && longitudfila<tamanio) ? 'colspan="'+(tamanio-longitudfila+1)+'"' : '';
                        if (campo === 'category')
                            campo = $('#' + zona + ' .dimension').html();
                        else if (campo === 'measure')
                            campo = trans.indicador + ' (' + $('#' + zona + ' .titulo_indicador').attr('formula') + ')';
                        tabla_datos += '<td '+ colspan +'>' + campo.toUpperCase() + '</td>';
                    }
                    tabla_datos += '</tr>';
                }
                    tabla_datos += '<tr tipo="contenido">';
                    var longitudfila = objSize(fila);
                    var count = 0;                
                    for (var i in fila){
                        count +=1;
                        var colspan = (count === longitudfila && longitudfila<tamanio) ? 'colspan="'+(tamanio-longitudfila+1)+'"' : '';
                        tabla_datos += '<td '+ colspan +'>' + fila[i] + '</td>';
                    }
                    tabla_datos += '</tr>';
            });
            return tabla_datos;
        }
        
        var objSize = function(obj) {
            var count = 0;
            if (typeof obj == "object") {
                if (Object.keys) {
                    count = Object.keys(obj).length;
                } else if (window._) {
                    count = _.keys(obj).length;
                } else if (window.$) {
                    count = $.map(obj, function() { return 1; }).length;
                } else {
                    for (var key in obj) if (obj.hasOwnProperty(key)) count++;
                }
            }
            return count;
        };
    $("#search_1").keyup(function(e) {   
        valor=this.value.toLowerCase();                                                                
        $('#miclasificacion').find('li').each(function(i,ele)
        {           
            var buscar=" "+$.trim($(ele).text().toLowerCase());                                                                                             
            if(buscar.indexOf(valor)<1)
                $("#miclasificacion li:nth-child("+(i+1)+")").attr("style","display:none");
            else 
                $("#miclasificacion li:nth-child("+(i+1)+")").removeAttr("style");
            if(valor=="")                                       
                $("#miclasificacion li:nth-child("+(i+1)+")").removeAttr("style");
        });
    }); 
    $("#clasificacion_00").change(function(e) {
        var uso=$(this).val();
        var valor=this.value.toLowerCase(); 
        che="";
        if(valor=="xxx")
        {
            valor=$("#clasificacion_00 option:nth-child(2)").val();                             
            indicadoresList(valor,"che","");
            $("#clasificacion_11").html("");
        }
        else
        {
            $("#miclasificacion").html("");
            $.ajax({
                url: Routing.generate("clasificacionTecnica",{'uso':uso,'ficha':"x"}),
                dataType:"json",    
                type: 'POST',
                error: function() 
                {
                    $("#clasificacion_11").html(li);
                },
                success: function(result) 
                {
                    var li="<option value=''>Seleccione</option>";
                    for (i = 0; i < result.length; i++) 
                    {
                        li+='<option value="'+result[i].id+'" >'+result[i].value+'</option>';
                    }
                    $("#clasificacion_11").html(li);                
                }
            });
            indicadoresList(valor,"","");
        }
    });
    $("#clasificacion_11").change(function(e) {     
        indicadoresList($("#clasificacion_00").val(),"",$(this).val());
    }); 
    
    $("#search_5").keyup(function(e) {   
        valor=this.value.toLowerCase();                                                                
        $('#misalax3').find('li').each(function(i,ele)
        {           
            var buscar=" "+$.trim($(ele).text().toLowerCase());                                                                                             
            if(buscar.indexOf(valor)<1)
                $("#misalax3 li:nth-child("+(i+1)+")").attr("style","display:none");
            else 
                $("#misalax3 li:nth-child("+(i+1)+")").removeAttr("style");
            if(valor=="")                                       
                $("#misalax3 li:nth-child("+(i+1)+")").removeAttr("style");
        });
    });     
    
                                
    $("#search_4").keyup(function(e) {   
        valor=this.value.toLowerCase();                                                                
        $('#misalax2').find('li').each(function(i,ele)
        {           
            var buscar=" "+$.trim($(ele).text().toLowerCase());                                                                                             
            if(buscar.indexOf(valor)<1)
                $("#misalax2 li:nth-child("+(i+1)+")").attr("style","display:none");
            else 
                $("#misalax2 li:nth-child("+(i+1)+")").removeAttr("style");
            if(valor=="")                                       
                $("#misalax2 li:nth-child("+(i+1)+")").removeAttr("style");
        });
    }); 
    
    $("#search_3").keyup(function(e) {   
        valor=this.value.toLowerCase();                                                                
        $('#misalax').find('li').each(function(i,ele)
        {           
            var buscar=" "+$.trim($(ele).text().toLowerCase());                                                                                             
            if(buscar.indexOf(valor)<1)
                $("#misalax li:nth-child("+(i+1)+")").attr("style","display:none");
            else 
                $("#misalax li:nth-child("+(i+1)+")").removeAttr("style");
            if(valor=="")                                       
                $("#misalax li:nth-child("+(i+1)+")").removeAttr("style");
        });
    }); 
    
    $("#search_2").keyup(function(e) {   
        valor=this.value.toLowerCase();                                                                
        $('#listado-favoritos').find('li').each(function(i,ele)
        {           
            var buscar=" "+$.trim($(ele).text().toLowerCase());                                                                                             
            if(buscar.indexOf(valor)<1)
                $("#listado-favoritos li:nth-child("+(i+1)+")").attr("style","display:none");
            else 
                $("#listado-favoritos li:nth-child("+(i+1)+")").removeAttr("style");
            if(valor=="")                                       
                $("#listado-favoritos li:nth-child("+(i+1)+")").removeAttr("style");
        });
    }); 
    function maximizar()
    {   
        var tam=(($(window).width())-150)/3;
        if((($(window).width())-120)<300)
            tam=($(window).width());
        if(tam<350&&tam>300)
            tam=(($(window).width())-150)/2;
        if(tam>400)
            tam=410;
        
        var h1=tam/1.64;
        var h2=tam/1.07;
            
        //$('.grafico').css({height:h1 , width: h2});
        //$('.area_grafico').css({height:tam , width: tam});
        
        var windowH = $(window).height();
        $('#listado-favoritos').css({'max-height':($(window).height()/2.5)+'px'});
        $('#listado-favoritos').css({'min-height':'70px'});
        $('#listado-favoritos').css({'overflow':'auto'});
        
        $('#miclasificacion').css({'max-height':($(window).height()/2.5)+'px'});
        $('#miclasificacion').css({'min-height':'70px'});
        $('#miclasificacion').css({'overflow':'auto'});
        
        $('#misalax').css({'max-height':($(window).height()/2.5)+'px'});
        $('#misalax').css({'min-height':'70px'});
        $('#misalax').css({'overflow':'auto'});
        
        $('#misalax2').css({'max-height':($(window).height()/2.5)+'px'});
        $('#misalax2').css({'min-height':'70px'});
        $('#misalax2').css({'overflow':'auto'});
        
        $('#misalax3').css({'max-height':($(window).height()/2.5)+'px'});
        $('#misalax3').css({'min-height':'70px'});
        $('#misalax3').css({'overflow':'auto'});
        $('#acciones_sala').css({'max-height':($(window).height()/2.5)+'px'});
        $('#acciones_sala').css({'min-height':'70px'});
        $('#acciones_sala').css({'overflow':'auto'});
        $('#content_mensajes').css({'max-height':($(window).height()/2.5)+'px'});
        $('#content_mensajes').css({'min-height':'70px'});
        $('#content_mensajes').css({'overflow':'auto'});
        
    }
    window.onresize=maximizar;
    window.onload=maximizar;
});
function openModalSala(sala,titulo,edit)
{
    $('#nombre_sala').attr('id-sala', sala);
    $('#nombre_sala').val(titulo);
    if(edit=="0")
    {
        $("#elimina_sala").attr("data-id",sala);
        $("#guardar_sala").attr("style","display:none");
        $("#elimina_sala").attr("style","display:");
    }
    else
    {       
        $("#guardar_sala").attr("style","display:");
        $("#elimina_sala").attr("style","display:none");
    }
}
function indicadoresList(valor,che,ft)
{
    $("#miclasificacion").html("");
    
    $.ajax({
        type: "POST",
        dataType:"JSON",                                
        url:(Routing.generate("change_clasificacion_uso",{codigo_clasificacion:valor})),
        data:{ajax:"ajax",che:che,ft:ft},
        success: function(datos) 
        {
            var li="";
            for(var c=0;c<datos.length; c++)
            {
                li=li+'<li class="list-group-item" style="height:100%; min-height:55px; width:100%; display:block;">'+
                '<button type="button" class="indicador pull-left btn" style="margin-right:15px" data-id="'+datos[c].id+'"'+
                'onclick="cargar_indicador('+datos[c].id+');" id="'+datos[c].id+'">'+
                '<i class="glyphicon glyphicon-plus"></i>'+
                '</button>'+datos[c].nombre+'<div class="clearfix"></div></li>';                                        
            }
            if(li=="")
                li="<div class='alert alert-warning col-lg-12'>No hay resultados</div>";                    
            $("#miclasificacion").append(li);
            marcar_agregados();
        }
    });
}

function imprimirSala() {
    $("#paraimprimir").html($("#sala").html());
    var tamano = $("#paraimprimir").find('.col-md-4').length;
    var cont = 0;
    $("#paraimprimir").find('.col-md-4').each(function(index,data) {  
        var numeros = $(data).find(".area_grafico").attr("data-id");
        $(data).find(".area_grafico").removeAttr("datasetprincipal_bk");
        $(data).find(".area_grafico").removeAttr("datasetprincipal");        
        $(data).attr("class", "col-md-12 col-sm-12 col-lg-12");
        aplicarFiltro("grafico_"+numeros);

        $(data).find("svg").attr("xmlns", "http://www.w3.org/2000/svg")
        $(data).find("svg").attr("version", "1.1");
        $(data).find("svg").attr("id", "grafico_"+numeros);
               
        $("table").attr("width", "630").attr("border",1);

        $(data).find(".controles").find(".btn-group").remove();
        $(data).find(".info").removeAttr("style");
        $(data).find(".info").find("th").attr("style","background-color:gainsboro");
        $(data).find(".info").find("table").attr("style","width:630").attr("border", 1);
        $(data).find(".controles").find(".modal").attr("style","width:631");
        $(data).find(".controles").find(".modal").find(".modal-header").remove();
        $(data).find(".controles").find(".modal").find(".modal-footer").remove();        
        $(data).find(".controles").find("#myFiltergrafico_"+numeros).remove();
        $(data).find(".controles").find(".modal:first").remove();
        $(data).find(".controles").find(".modal").removeAttr("class");
        $(data).find(".panel-footer").remove();
        
        var titulo = $(data).find(".titulo").html();
        var tabla0 = $(data).find(".controles").find("#myAlertgrafico_"+numeros).find(".modal-body").html();
        var tabla1 = $(data).find(".controles").find("#myFiltergrafico_"+numeros).find(".modal-body").html();
        var tabla2 = $(data).find(".controles").find("#myNotegrafico_"+numeros).find(".modal-body").html();    
        var tabla3 = $(data).find(".info").html();
        html2canvas($("#grafico_"+numeros), {
            onrendered: function(canvas) {                
                var myImage = canvas.toDataURL();
                var image = document.createElement("img");
                image.setAttribute('width', '630');
                image.src = myImage;

                $(data).html("");
                $(data).append("<h3>"+titulo+"</h3><br>");
                $(data).append(tabla0);
                $(data).append(tabla1);
                $(data).append(tabla2);
                $(data).append(tabla3);
                $(data).append('<br><div class="imagen" align="center"></div>');
                $(data).find(".imagen").append(image);
                cont++;
                imprimir_sala(tamano, cont);
            }
        });
        /*var grafico = $(data).find(".grafico").html();
        var withSvgAsImage = [
            '<img src="data:image/svg+xml;charset=utf-8,' + encodeURIComponent([
                grafico
                ].join('\n')) + '"/>'
        ].join('\n');
        addSvgAsImage(getSvgForContent(withSvgAsImage),$(data).find(".row_grafico"));*/

    });    
}
function imprimir_sala(tamano, cont){
    if(tamano == cont){
        setTimeout(function(){      
            var json = {};
            json.html = window.encodeURIComponent($("#paraimprimir").html());
            json.header = $("#header_sala").html();
            json.footer = "eTAB Chiapas";
            json.nombre = $("#header_sala").text();
            if(json){
                $("#htmlhtml").val(json.html);
                $("#htmlheader").val(json.header);
                $("#htmlfooter").val(json.footer);
                $("#htmlnombre").val(json.nombre);
                $("#htmlconstruido").attr("action",Routing.generate("html_pdf"));
                $("#htmlconstruido").submit();
            }
        }, 100);
    }
}

acciones_button();

var getSvgForContent = function (content) {
    return [
        '<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="300">',
        '<foreignObject width="100%" height="100%">',
        '<html xmlns="http://www.w3.org/1999/xhtml"><head></head>',
        '<body>',
        '<style type="text/css">body {font-size: 16px;}</style>',
        content,
        '</body>',
        '</html>',
        '</foreignObject>',
        '</svg>'
    ].join('\n');
};

var addSvgAsImage = function (svgCode, agregar) {
    var image = document.createElement("img");
    image.setAttribute('width', '100%');
    image.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgCode);
    $(agregar).append(image);

    var canvas = document.createElement("canvas");
    canvas.width = 700;
    canvas.height = 500;
    $(agregar).append(canvas);

    canvas.getContext('2d').drawImage(image, 0, 0, 700, 500);
};

</script>


{% endblock %}